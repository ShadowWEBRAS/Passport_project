{% extends 'users/home.html' %}
{% load static %}

{% block title %}Создание паспорта оборудования{% endblock %}

{% block extrastyle %}
<style>
  :root {
    --primary-color: #4361ee;
    --secondary-color: #3f37c9;
    --accent-color: #4895ef;
    --light-color: #f8f9fa;
    --dark-color: #212529;
    --success-color: #4bb543;
    --danger-color: #f44336;
    --warning-color: #ff9800;
    --border-radius: 8px;
    --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    --transition: all 0.3s ease;
  }

  .content {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
    background: white;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
  }

  .content-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 15px;
    border-bottom: 1px solid #e9ecef;
  }

  .content-header h2 {
    color: #1e5799;
    font-weight: 500;
  }

  .btn {
    background-color: #1e5799;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: var(--border-radius);
    cursor: pointer;
    font-size: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: var(--transition);
  }

  .btn:hover {
    background-color: #0a3d62;
    transform: translateY(-2px);
  }

  .form-section {
    margin-bottom: 30px;
    padding: 20px;
    background-color: #f8f9fa;
    border-radius: var(--border-radius);
  }

  .form-section h3 {
    color: #1e5799;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid #dee2e6;
  }

  .form-row {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
  }

  .form-group {
    flex: 1;
    margin-bottom: 15px;
  }

  label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #495057;
  }

  label.required::after {
    content: " *";
    color: var(--danger-color);
  }

  input[type="text"],
  input[type="date"],
  select,
  textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid #ced4da;
    border-radius: var(--border-radius);
    font-size: 16px;
    transition: var(--transition);
  }

  input[type="text"]:focus,
  input[type="date"]:focus,
  select:focus,
  textarea:focus {
    border-color: var(--accent-color);
    outline: none;
    box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
  }

  textarea {
    min-height: 100px;
    resize: vertical;
  }

  select {
    appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 10px center;
    background-size: 1em;
  }

  .error {
    color: #dc3545;
    font-size: 14px;
    margin-top: 5px;
  }

  @media (max-width: 768px) {
    .content-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 15px;
    }

    .form-row {
      flex-direction: column;
      gap: 0;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="content">
  <div class="content-header">
    <h2>Создание нового паспорта оборудования</h2>
    <button type="submit" form="passportForm" class="btn btn-save">
      <i class="fas fa-save"></i> Сохранить паспорт
    </button>
  </div>

  <form method="post" enctype="multipart/form-data" id="passportForm">
    {% csrf_token %}

    <div class="form-section">
      <h3>Основная информация</h3>

      <div class="form-row">
        <div class="form-group">
          <label class="required">Наименование оборудования</label>
          {{ form.name }}
          {% if form.name.errors %}
            <div class="error">{{ form.name.errors }}</div>
          {% endif %}
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="required">Заводской номер</label>
          {{ form.serial_number }}
          {% if form.serial_number.errors %}
            <div class="error">{{ form.serial_number.errors }}</div>
          {% endif %}
        </div>
        <div class="form-group">
          <label class="required">Инвентарный номер</label>
          {{ form.inventory_number }}
          {% if form.inventory_number.errors %}
            <div class="error">{{ form.inventory_number.errors }}</div>
          {% endif %}
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="required">Дата изготовления</label>
          {{ form.production_date }}
          {% if form.production_date.errors %}
            <div class="error">{{ form.production_date.errors }}</div>
          {% endif %}
        </div>
        <div class="form-group">
          <label class="required">Дата ввода в эксплуатацию</label>
          {{ form.commissioning_date }}
          {% if form.commissioning_date.errors %}
            <div class="error">{{ form.commissioning_date.errors }}</div>
          {% endif %}
        </div>
      </div>

      <!-- Добавление поля для выбора типа оборудования -->
      <div class="form-row">
        <div class="form-group">
          <label>Тип оборудования</label>
          <input type="text" name="equipment_type_name" list="equipment-types">
          <datalist id="equipment-types">
            {% for type in equipment_types %}
              <option value="{{ type.name }}">
            {% endfor %}
          </datalist>
        </div>
      </div>
    </div>

    <div class="form-group">
      <label>Описание</label>
      {{ form.description }}
      {% if form.description.errors %}
        <div class="error">{{ form.description.errors }}</div>
      {% endif %}
    </div>

    <div class="form-section">
      <h3>Эксплуатационные данные</h3>
      <div class="form-row">
        <div class="form-group">
          <label class="required">Место установки</label>
          {{ form.location }}
          {% if form.location.errors %}
            <div class="error">{{ form.location.errors }}</div>
          {% endif %}
        </div>
        <div class="form-group">
          <label>Ответственное лицо</label>
          {{ form.responsible_person }}
          {% if form.responsible_person.errors %}
            <div class="error">{{ form.responsible_person.errors }}</div>
          {% endif %}
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Статус оборудования</label>
          {{ form.status }}
          {% if form.status.errors %}
            <div class="error">{{ form.status.errors }}</div>
          {% endif %}
        </div>
        <div class="form-group">
          <label>Дата последнего ТО</label>
          {{ form.last_maintenance }}
          {% if form.last_maintenance.errors %}
            <div class="error">{{ form.last_maintenance.errors }}</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Пользовательские поля -->
    <div class="form-section">
      <h3>Пользовательские поля</h3>

      <div id="custom-fields-container">
        <!-- Здесь будут добавляться пользовательские поля -->
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Новое поле</label>
          <input type="text" id="new-field-name" placeholder="Название поля">
        </div>
        <div class="form-group">
          <label>Тип</label>
          <select id="new-field-type">
            <option value="text">Текст</option>
            <option value="number">Число</option>
            <option value="date">Дата</option>
            <option value="boolean">Да/Нет</option>
          </select>
        </div>
        <div class="form-group" style="align-self: end;">
          <button type="button" id="add-field-btn" class="btn btn-primary">Добавить поле</button>
        </div>
      </div>

      <input type="hidden" name="custom_fields_json" id="custom-fields-json" value="{}">
    </div>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Обработка кнопки сохранения
    document.querySelector('.btn-save').addEventListener('click', function() {
        document.querySelector('form').submit();
    });

    // JavaScript для управления custom fields
    const customFieldsContainer = document.getElementById('custom-fields-container');
    const customFieldsJson = document.getElementById('custom-fields-json');

    // Функция для обновления JSON
    function updateCustomFieldsJson() {
        const fields = {};
        document.querySelectorAll('.custom-field-row').forEach(row => {
            const fieldName = row.querySelector('.field-name').value;
            const fieldValue = row.querySelector('.field-value').value;
            const fieldType = row.querySelector('.field-type').value;

            if (fieldName) {
                fields[fieldName] = {
                    value: fieldValue,
                    type: fieldType
                };
            }
        });
        customFieldsJson.value = JSON.stringify(fields);
    }

    // Добавление нового поля
    document.getElementById('add-field-btn').addEventListener('click', function() {
        const fieldName = document.getElementById('new-field-name').value;
        const fieldType = document.getElementById('new-field-type').value;

        if (!fieldName) {
            alert('Введите название поля');
            return;
        }

        const fieldRow = document.createElement('div');
        fieldRow.className = 'custom-field-row';
        fieldRow.innerHTML = `
            <div class="form-row">
                <div class="form-group">
                    <label>Название поля</label>
                    <input type="text" name="custom_field_name" value="${fieldName}" class="field-name" readonly>
                </div>
                <div class="form-group">
                    <label>Значение</label>
                    <input type="text" name="custom_field_value" class="field-value">
                </div>
                <div class="form-group">
                    <label>Тип</label>
                    <select name="custom_field_type" class="field-type" disabled>
                        <option value="text" ${fieldType === 'text' ? 'selected' : ''}>Текст</option>
                        <option value="number" ${fieldType === 'number' ? 'selected' : ''}>Число</option>
                        <option value="date" ${fieldType === 'date' ? 'selected' : ''}>Дата</option>
                        <option value="boolean" ${fieldType === 'boolean' ? 'selected' : ''}>Да/Нет</option>
                    </select>
                </div>
                <div class="form-group" style="align-self: end;">
                    <button type="button" class="btn btn-danger remove-field">Удалить</button>
                </div>
            </div>
        `;

        customFieldsContainer.appendChild(fieldRow);
        document.getElementById('new-field-name').value = '';

        // Навешиваем обработчик удаления
        fieldRow.querySelector('.remove-field').addEventListener('click', function() {
            fieldRow.remove();
            updateCustomFieldsJson();
        });

        // Навешиваем обработчик изменения значения
        fieldRow.querySelector('.field-value').addEventListener('change', updateCustomFieldsJson);

        updateCustomFieldsJson();
    });
});
</script>
{% endblock %}